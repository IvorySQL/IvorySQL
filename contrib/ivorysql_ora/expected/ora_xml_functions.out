--
-- Test Ivorysql compatible oracle XML functions
--
create table inaf(a int, b xmltype);
insert into inaf values(1,xmltype('<a><b>100</b></a>'));
insert into inaf values(2, '');
select * from inaf;
 a |         b         
---+-------------------
 1 | <a><b>100</b></a>
 2 | 
(2 rows)

create table xmltest(id int, data XMLType);
insert into xmltest values(1, '<value>one</value>');
insert into xmltest values(2, '<value>two</value>');
select * from xmltest;
 id |        data        
----+--------------------
  1 | <value>one</value>
  2 | <value>two</value>
(2 rows)

create table xmlnstest(id int, data xmltype);
INSERT INTO xmlnstest VALUES(1, xmltype('<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"><soapenv:Body><web:BBB><typ:EEE>41</typ:EEE><typ:FFF>42</typ:FFF></web:BBB></soapenv:Body></soapenv:Envelope>'));
--
-- extrct(XML)
--
SELECT extract(XMLType('<AA><ID>1</ID></AA>'), '/AA/ID') from dual;
  extract   
------------
 <ID>1</ID>
(1 row)

SELECT extract(XMLType('<AA><ID>1</ID></AA>'), '/AA') from dual;
   extract    
--------------
 <AA>        +
   <ID>1</ID>+
 </AA>
(1 row)

SELECT extract(XMLType('<Co Attr ="Test Attr"><ID>1</ID></Co>'), '/Co') from dual;
        extract        
-----------------------
 <Co Attr="Test Attr">+
   <ID>1</ID>         +
 </Co>
(1 row)

SELECT extract(XMLType('<Co Attr ="Test Attr"><ID>1</ID></Co>'), '/Co/@ Attr') from dual;
  extract  
-----------
 Test Attr
(1 row)

SELECT extract(XMLType('<a><b>b1</b><b>b2</b></a>'),'/a/b[2]') from dual;
  extract  
-----------
 <b>b2</b>
(1 row)

SELECT extract(XMLType('<a><b>b1</b><b>b2</b></a>'),'/a/b[3]') from dual;
 extract 
---------
 
(1 row)

SELECT extract(b, '/a/b') from inaf where a = 2;
 extract 
---------
 
(1 row)

SELECT extract(XMLType('<a><b>b1</b><b>b2</b></a>'),'') from dual;
 extract 
---------
 
(1 row)

SELECT extract(XMLType('<a><b>b1</b><b>b2</b></a>'),null) from dual;
 extract 
---------
 
(1 row)

SELECT extract(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE', 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                       extract                        
------------------------------------------------------
 <typ:EEE xmlns:typ="http://www.def.com">41</typ:EEE>
(1 row)

--
-- extractvalue
--
SELECT extractvalue(XMLType('<a><b>100</b></a>'),'/a/b') from dual;
 extractvalue 
--------------
 100
(1 row)

SELECT extractvalue(XMLType('<a><b>100</b></a>'),'/a') from dual;
ERROR:  EXTRACTVALUE can only retrieve value of leaf node
SELECT extractvalue(b, '/a/b') from inaf where a = 2;
 extractvalue 
--------------
 
(1 row)

SELECT extractvalue(XMLType('<a><b>b</b></a>'), '') from dual;
 extractvalue 
--------------
 
(1 row)

SELECT extractvalue(XMLType('<a><b>b</b></a>'), null) from dual;
 extractvalue 
--------------
 
(1 row)

SELECT extractvalue(XMLType('<a><b>b1</b><b>b2</b></a>'),'/a/b[1]') from dual;
 extractvalue 
--------------
 b1
(1 row)

SELECT extractvalue(XMLType('<a><b>b1</b><b>b2</b></a>'),'/a/b[2]') from dual;
 extractvalue 
--------------
 b2
(1 row)

SELECT extractvalue(XMLType('<a><b>b1</b><b>b2</b></a>'),'/a/b') from dual;
ERROR:  EXTRACTVALUE returns value of only one node
SELECT extractvalue(XMLType('<a><b><c><d><e>111></e><f>222</f></d></c></b></a>'),'/a/b/c/d') from dual;
ERROR:  EXTRACTVALUE returns value of only one node
SELECT extractvalue(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE', 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
 extractvalue 
--------------
 41
(1 row)

--
-- existsnode
--
SELECT existsnode(XMLType('<a><b>d</b></a>'), '/a') from dual;
 existsnode 
------------
          1
(1 row)

SELECT existsnode(XMLType('<a><b>d</b></a>'), '/a/b') from dual;
 existsnode 
------------
          1
(1 row)

SELECT existsnode(XMLType('<a><b>d</b></a>'), '/a/b/c') from dual;
 existsnode 
------------
          0
(1 row)

SELECT existsnode(b, '/a/b') from inaf where a = 2;
 existsnode 
------------
           
(1 row)

SELECT existsnode(XMLType('<a><b>d</b></a>'), '') from dual;
 existsnode 
------------
           
(1 row)

SELECT existsnode(XMLType('<a><b>d</b></a>'), null) from dual;
 existsnode 
------------
           
(1 row)

SELECT existsnode(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE', 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
 existsnode 
------------
          1
(1 row)

--
-- deletexml
--
SELECT deletexml(XMLType('<test><value>oldnode</value><value>oldnode</value></test>'),
  '/test/value') from dual;
 deletexml 
-----------
 <test/>
(1 row)

SELECT deletexml(XMLType('<test><value>111</value><value>222</value></test>'),
  '/test/value[1]') from dual;
      deletexml       
----------------------
 <test>              +
   <value>222</value>+
 </test>
(1 row)

SELECT deletexml(XMLType('<test><value>111</value><value>222</value></test>'),
  '/test/value[2]') from dual;
      deletexml       
----------------------
 <test>              +
   <value>111</value>+
 </test>
(1 row)

SELECT deletexml(XMLType('<a><b></b><b></b></a>'), '//b') from dual;
 deletexml 
-----------
 <a/>
(1 row)

SELECT deletexml(XMLType('<a><b></b><b></b></a>'), '/a') from dual;
 deletexml 
-----------
 
(1 row)

SELECT deletexml(b, '/a/b') from inaf where a = 2;
 deletexml 
-----------
 
(1 row)

SELECT deletexml(XMLType('<test><value></value><value><t>11</t></value></test>'),
  '/test/value/t') from dual;
 deletexml  
------------
 <test>    +
   <value/>+
   <value/>+
 </test>
(1 row)

SELECT deletexml(XMLType('<test><value>12</value><value><t>12</t><b>12</b></value></test>'),
  '/test/value/t') from dual;
      deletexml      
---------------------
 <test>             +
   <value>12</value>+
   <value>          +
     <b>12</b>      +
   </value>         +
 </test>
(1 row)

SELECT deletexml(XMLType('<a><b></b><b></b></a>'), '') from dual;
 deletexml 
-----------
 
(1 row)

SELECT deletexml(XMLType('<a><b></b><b></b></a>'), null) from dual;
 deletexml 
-----------
 
(1 row)

SELECT deletexml(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE', 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                                                                 deletexml                                                                  
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Body>                                                                                                                          +
     <web:BBB>                                                                                                                             +
       <typ:FFF>42</typ:FFF>                                                                                                               +
     </web:BBB>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

--
-- appendchildxml
--
SELECT appendchildxml(XMLType('<test><value></value><value></value></test>'),
  '/test/value', XMLTYPE('<name>newnode</name>')) from dual;
      appendchildxml      
--------------------------
 <test>                  +
   <value>               +
     <name>newnode</name>+
   </value>              +
   <value>               +
     <name>newnode</name>+
   </value>              +
 </test>
(1 row)

SELECT appendchildxml(XMLType('<test><a></a><b></b></test>'),
  '/test/a', XMLTYPE('<name>aaa</name>')) from dual;
    appendchildxml    
----------------------
 <test>              +
   <a>               +
     <name>aaa</name>+
   </a>              +
   <b/>              +
 </test>
(1 row)

SELECT appendchildxml(XMLType('<a><b></b><b></b></a>'), '/a/b', XMLtype('<name>1000</name>')) from dual;
    appendchildxml     
-----------------------
 <a>                  +
   <b>                +
     <name>1000</name>+
   </b>               +
   <b>                +
     <name>1000</name>+
   </b>               +
 </a>
(1 row)

SELECT appendchildxml(XMLType('<a><b></b></a>'), '/a', XMLtype('<name>1000</name>')) from dual;
   appendchildxml    
---------------------
 <a>                +
   <b/>             +
   <name>1000</name>+
 </a>
(1 row)

SELECT appendchildxml(b, '/a/b', XMLtype('<name>1000</name>')) from inaf where a = 2;
 appendchildxml 
----------------
 
(1 row)

SELECT appendchildxml(XMLType('<a><b>666</b></a>'), '/a/b', XMLtype('<name>1000<mm>66</mm></name>')) from dual;
              appendchildxml              
------------------------------------------
 <a>                                     +
   <b>666<name>1000<mm>66</mm></name></b>+
 </a>
(1 row)

SELECT appendchildxml(XMLType('<ers:OPS xmlns:ers="http://www.test.com/schema/ers/v3"></ers:OPS>'), '/ers:OPS', XMLType('<ers:LOG xmlns:ers="http://www.test.com/schema/ers/v3" IVY="666"></ers:LOG>'),'xmlns:ers="http://www.test.com/schema/ers/v3"') from dual;
                            appendchildxml                            
----------------------------------------------------------------------
 <ers:OPS xmlns:ers="http://www.test.com/schema/ers/v3">             +
   <ers:LOG xmlns:ers="http://www.test.com/schema/ers/v3" IVY="666"/>+
 </ers:OPS>
(1 row)

--
-- updatexml
--
SELECT updatexml(xmltype('<value>one</value>'), '/value', xmltype('<newvalue>1111</newvalue>')) FROM dual;
         updatexml         
---------------------------
 <newvalue>1111</newvalue>
(1 row)

SELECT updatexml(b, '/a/b', xmltype('<b>1111</b>')) from inaf where a = 2;
 updatexml 
-----------
 
(1 row)

SELECT updatexml(data, '/value', xmltype('<newvalue>newnode</newvalue>')) FROM xmltest;
          updatexml           
------------------------------
 <newvalue>newnode</newvalue>
 <newvalue>newnode</newvalue>
(2 rows)

SELECT updatexml(data, '/value/text()', '1000') FROM xmltest;
      updatexml      
---------------------
 <value>1000</value>
 <value>1000</value>
(2 rows)

SELECT updatexml(XMLTYPE('<a><b>b1</b><b>b2</b></a>'), '/b', '1000') FROM dual;
  updatexml  
-------------
 <a>        +
   <b>b1</b>+
   <b>b2</b>+
 </a>
(1 row)

SELECT updatexml(XMLTYPE('<a><b>b1</b><b>b2</b></a>'), '/b[1]/text()', '1000') FROM dual;
  updatexml  
-------------
 <a>        +
   <b>b1</b>+
   <b>b2</b>+
 </a>
(1 row)

SELECT updatexml(XMLTYPE('<a><b>b1</b><b>b2</b></a>'), '//b/text()', '1000') FROM dual;
   updatexml   
---------------
 <a>          +
   <b>1000</b>+
   <b>1000</b>+
 </a>
(1 row)

SELECT updatexml(XMLTYPE('<a><b>b1</b><b>b2</b></a>'), '//b[1]/text()', '222') FROM dual;
  updatexml   
--------------
 <a>         +
   <b>222</b>+
   <b>b2</b> +
 </a>
(1 row)

UPDATE xmltest SET data = UPDATEXML(data, '/value/text()', 'second') WHERE id = 2;
select * from xmltest;
 id |         data          
----+-----------------------
  1 | <value>one</value>
  2 | <value>second</value>
(2 rows)

SELECT updatexml(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE/text()',123, 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                                                                 updatexml                                                                  
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Body>                                                                                                                          +
     <web:BBB>                                                                                                                             +
       <typ:EEE>123</typ:EEE>                                                                                                              +
       <typ:FFF>42</typ:FFF>                                                                                                               +
     </web:BBB>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

--
-- insertxmlbefore
--
SELECT insertxmlbefore(XMLType('<a>a</a>'),'/a', XMLType('<b>b</b>')) from dual;
ERROR:  invalid XPath expression
SELECT insertxmlbefore(XMLType('<a><b>b</b></a>'),'/a/b', XMLType('<c>c</c>')) from dual;
 insertxmlbefore 
-----------------
 <a>            +
   <c>c</c>     +
   <b>b</b>     +
 </a>
(1 row)

SELECT insertxmlbefore(XMLType('<a><b></b></a>'),'/a/b', XMLType('<c></c>')) from dual;
 insertxmlbefore 
-----------------
 <a>            +
   <c/>         +
   <b/>         +
 </a>
(1 row)

SELECT insertxmlbefore(XMLType('<a>222<b>100</b></a>'), '/a/b', XMLTYPE('<c>88</c>')) from dual;
        insertxmlbefore        
-------------------------------
 <a>222<c>88</c><b>100</b></a>
(1 row)

SELECT insertxmlbefore(XMLType('<a>222<b>100</b><b>200</b></a>'), '/a/b', XMLTYPE('<c>88</c>')) from dual;
                 insertxmlbefore                  
--------------------------------------------------
 <a>222<c>88</c><b>100</b><c>88</c><b>200</b></a>
(1 row)

SELECT insertxmlbefore(XMLType('<a>222<b>100</b><b>200</b></a>'), '/a/b[1]', XMLTYPE('<c>88</c>')) from dual;
             insertxmlbefore             
-----------------------------------------
 <a>222<c>88</c><b>100</b><b>200</b></a>
(1 row)

SELECT insertxmlbefore(XMLType('<a>222<b>100</b><b>200</b></a>'), '/a/b[2]', XMLTYPE('<c>88</c>')) from dual;
             insertxmlbefore             
-----------------------------------------
 <a>222<b>100</b><c>88</c><b>200</b></a>
(1 row)

SELECT insertxmlbefore(XMLType('<a>222<b>100</b><b>200</b></a>'), '/b', XMLTYPE('<c>88</c>')) from dual;
        insertxmlbefore         
--------------------------------
 <a>222<b>100</b><b>200</b></a>
(1 row)

SELECT insertxmlbefore(b,'/a/b', XMLType('<c>200</c>')) from inaf where a = 2;
 insertxmlbefore 
-----------------
 
(1 row)

SELECT insertxmlbefore(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE', XMLType('<typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                                                              insertxmlbefore                                                               
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Body>                                                                                                                          +
     <web:BBB>                                                                                                                             +
       <typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>                                                                             +
       <typ:EEE>41</typ:EEE>                                                                                                               +
       <typ:FFF>42</typ:FFF>                                                                                                               +
     </web:BBB>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

--
-- insertxmlafter
--
SELECT insertxmlafter(XMLType('<a><b>100</b></a>'),'/a/b',XMLType('<c>88</c>')) from dual;
 insertxmlafter 
----------------
 <a>           +
   <b>100</b>  +
   <c>88</c>   +
 </a>
(1 row)

SELECT insertxmlafter(XMLType('<a>200<b>100</b><b>300</b></a>'),'/a/b',XMLType('<c>88</c>')) from dual;
                  insertxmlafter                  
--------------------------------------------------
 <a>200<b>100</b><c>88</c><b>300</b><c>88</c></a>
(1 row)

SELECT insertxmlafter(XMLType('<a>200<b>100</b><b>300</b></a>'),'/a/b[1]',XMLType('<c>88</c>')) from dual;
             insertxmlafter              
-----------------------------------------
 <a>200<b>100</b><c>88</c><b>300</b></a>
(1 row)

SELECT insertxmlafter(XMLType('<a>200<b>100</b><b>300</b></a>'),'/a/b[2]',XMLType('<c>88</c>')) from dual;
             insertxmlafter              
-----------------------------------------
 <a>200<b>100</b><b>300</b><c>88</c></a>
(1 row)

SELECT insertxmlafter(XMLType('<a>200<b>100</b><b>300</b></a>'),'/b',XMLType('<c>88</c>')) from dual;
         insertxmlafter         
--------------------------------
 <a>200<b>100</b><b>300</b></a>
(1 row)

SELECT insertxmlafter(b,'/a/b', XMLType('<c>200</c>')) from inaf where a = 2;
 insertxmlafter 
----------------
 
(1 row)

SELECT insertxmlafter(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE', XMLType('<typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                                                               insertxmlafter                                                               
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Body>                                                                                                                          +
     <web:BBB>                                                                                                                             +
       <typ:EEE>41</typ:EEE>                                                                                                               +
       <typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>                                                                             +
       <typ:FFF>42</typ:FFF>                                                                                                               +
     </web:BBB>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

--
-- insertchildxml
--
SELECT insertchildxml(XMLType('<a>one<b></b>three<b></b></a>'), '//b', 'name', XMLTYPE('<name>newnode</name>')) from dual;
                            insertchildxml                             
-----------------------------------------------------------------------
 <a>one<b><name>newnode</name></b>three<b><name>newnode</name></b></a>
(1 row)

SELECT insertchildxml(XMLType('<a><b>100</b></a>'), '/a/b', 'c', XMLType('<c>88</c>')) from dual;
    insertchildxml     
-----------------------
 <a>                  +
   <b>100<c>88</c></b>+
 </a>
(1 row)

SELECT insertchildxml(XMLType('<a><b>100</b></a>'), '/a/b', 'c', XMLType('<m>88</m>')) from dual;
ERROR:  The document being inserted does not conform to specified child name
SELECT insertchildxml(b, '/a/b', 'c', XMLType('<c>200</c>')) from inaf where a = 2;
 insertchildxml 
----------------
 
(1 row)

SELECT insertchildxml(XMLType('<a><b>100</b><b>200</b></a>'), '/a/b', 'c', XMLType('<c>88</c>')) from dual;
    insertchildxml     
-----------------------
 <a>                  +
   <b>100<c>88</c></b>+
   <b>200<c>88</c></b>+
 </a>
(1 row)

SELECT insertchildxml(XMLType('<a><b>100</b><b>200</b></a>'), '/a/b[1]', 'c', XMLType('<c>88</c>')) from dual;
    insertchildxml     
-----------------------
 <a>                  +
   <b>100<c>88</c></b>+
   <b>200</b>         +
 </a>
(1 row)

SELECT insertchildxml(XMLType('<a><b>100</b><b>200</b></a>'), '/a/b[2]', 'c', XMLType('<c>88</c>')) from dual;
    insertchildxml     
-----------------------
 <a>                  +
   <b>100</b>         +
   <b>200<c>88</c></b>+
 </a>
(1 row)

SELECT insertchildxml(XMLType('<a><b>100</b><b>200</b></a>'), '/a/b[2]', '"c"', XMLType('<c>88</c>')) from dual;
ERROR:  The document being inserted does not conform to specified child name
SELECT insertchildxml(data, 'soapenv:Envelope/soapenv:Body/web:BBB/typ:EEE','typ:IVY', XMLType('<typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                                                               insertchildxml                                                               
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Body>                                                                                                                          +
     <web:BBB>                                                                                                                             +
       <typ:EEE>41<typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY></typ:EEE>                                                        +
       <typ:FFF>42</typ:FFF>                                                                                                               +
     </web:BBB>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

--
-- insertchildxmlbefore
--
SELECT insertchildxmlbefore(XMLType('<a><b>100</b></a>'), '/a/b', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlbefore 
----------------------
 <a>                 +
   <b>100</b>        +
 </a>
(1 row)

SELECT insertchildxmlbefore(XMLType('<a><b>100</b></a>'), '/a', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlbefore 
----------------------
 <a>                 +
   <c>88</c>         +
   <b>100</b>        +
 </a>
(1 row)

SELECT insertchildxmlbefore(XMLType('<a><b>100</b><b>200</b></a>'), '/a', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlbefore 
----------------------
 <a>                 +
   <c>88</c>         +
   <b>100</b>        +
   <c>88</c>         +
   <b>200</b>        +
 </a>
(1 row)

SELECT insertchildxmlbefore(XMLType('<a><b>100</b><b>200</b></a>'), '/a', 'b[1]', XMLType('<c>88</c>')) from dual;
 insertchildxmlbefore 
----------------------
 <a>                 +
   <c>88</c>         +
   <b>100</b>        +
   <b>200</b>        +
 </a>
(1 row)

SELECT insertchildxmlbefore(XMLType('<a><b>100</b><b>200</b></a>'), '/a', 'b[2]', XMLType('<c>88</c>')) from dual;
 insertchildxmlbefore 
----------------------
 <a>                 +
   <b>100</b>        +
   <c>88</c>         +
   <b>200</b>        +
 </a>
(1 row)

SELECT insertchildxmlbefore(b, '/a', 'b', XMLType('<c>200</c>')) from inaf where a = 2;
 insertchildxmlbefore 
----------------------
 
(1 row)

SELECT insertchildxmlbefore(XMLType('<a><b>100</b><b>200</b></a>'), '/a/b[1]', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlbefore 
----------------------
 <a>                 +
   <b>100</b>        +
   <b>200</b>        +
 </a>
(1 row)

SELECT insertchildxmlbefore(data, 'soapenv:Envelope/soapenv:Body/web:BBB','typ:FFF', XMLType('<typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                                                            insertchildxmlbefore                                                            
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Body>                                                                                                                          +
     <web:BBB>                                                                                                                             +
       <typ:EEE>41</typ:EEE>                                                                                                               +
       <typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>                                                                             +
       <typ:FFF>42</typ:FFF>                                                                                                               +
     </web:BBB>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

--
-- insertchildxmlafter
--
SELECT insertchildxmlafter(XMLType('<a><b>100</b></a>'), '/a/b', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlafter 
---------------------
 <a>                +
   <b>100</b>       +
 </a>
(1 row)

SELECT insertchildxmlafter(XMLType('<a><b>100</b></a>'), '/a', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlafter 
---------------------
 <a>                +
   <b>100</b>       +
   <c>88</c>        +
 </a>
(1 row)

SELECT insertchildxmlafter(XMLType('<a><b>100</b><b>200</b></a>'), '/a', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlafter 
---------------------
 <a>                +
   <b>100</b>       +
   <c>88</c>        +
   <b>200</b>       +
   <c>88</c>        +
 </a>
(1 row)

SELECT insertchildxmlafter(XMLType('<a><b>100</b><b>200</b></a>'), '/a', 'b[1]', XMLType('<c>88</c>')) from dual;
 insertchildxmlafter 
---------------------
 <a>                +
   <b>100</b>       +
   <c>88</c>        +
   <b>200</b>       +
 </a>
(1 row)

SELECT insertchildxmlafter(XMLType('<a><b>100</b><b>200</b></a>'), '/a', 'b[2]', XMLType('<c>88</c>')) from dual;
 insertchildxmlafter 
---------------------
 <a>                +
   <b>100</b>       +
   <b>200</b>       +
   <c>88</c>        +
 </a>
(1 row)

SELECT insertchildxmlafter(b, '/a', 'b', XMLType('<c>200</c>')) from inaf where a = 2;
 insertchildxmlafter 
---------------------
 
(1 row)

SELECT insertchildxmlafter(XMLType('<a><b>100</b><b>200</b></a>'), '/a/b[1]', 'b', XMLType('<c>88</c>')) from dual;
 insertchildxmlafter 
---------------------
 <a>                +
   <b>100</b>       +
   <b>200</b>       +
 </a>
(1 row)

SELECT insertchildxmlafter(data, 'soapenv:Envelope/soapenv:Body/web:BBB','typ:FFF', XMLType('<typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') from xmlnstest where id = 1;
                                                            insertchildxmlafter                                                             
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Body>                                                                                                                          +
     <web:BBB>                                                                                                                             +
       <typ:EEE>41</typ:EEE>                                                                                                               +
       <typ:FFF>42</typ:FFF>                                                                                                               +
       <typ:IVY xmlns:typ="http://www.def.com">Ivory</typ:IVY>                                                                             +
     </web:BBB>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

--
-- xmlisvalid
--
SELECT xmlisvalid(XMLType('<a/>'));
 xmlisvalid 
------------
 t
(1 row)

SELECT xmlisvalid(XMLType('<a>'));
 xmlisvalid 
------------
 f
(1 row)

--
-- xmlelement
--
SELECT xmlelement('a');
ERROR:  syntax error at or near "'a'"
LINE 1: SELECT xmlelement('a');
                          ^
SELECT xmlelement("Employee"), xmlelement("Id", x.id), xmlelement("Data", x.data) as "Result" from xmltest x;
 xmlelement  | xmlelement |                     Result                     
-------------+------------+------------------------------------------------
 <Employee/> | <Id>1</Id> | <Data>&lt;value&gt;one&lt;/value&gt;</Data>
 <Employee/> | <Id>2</Id> | <Data>&lt;value&gt;second&lt;/value&gt;</Data>
(2 rows)

drop table inaf;
drop table xmltest;
drop table xmlnstest;
--
-- Fix BUG#Z202, BUG#Z203, BUG#Z204, BUG#Z205
--
create table warehouse_1(
	warehouse_id	number(3) not null,
	warehouse_spec	xmltype,
	warehouse_name	varchar2(35)
);
insert into warehouse_1 values(1,
	'<?xml version="1.0" encoding="UTF-8"?>
	  <Envelope>
	   <Header />
	   <Body>
	    <AAA>
	     <BBB>
	      <Version>1.0</Version>
	      <DDD>
	       <EEE>11</EEE>
	       <FFF>12</FFF>
	       <DDDs>
	        <DDD>
	         <EEE>111</EEE>
	         <FFF>112</FFF>
	        </DDD>
	       </DDDs>
	      </DDD>
	     </BBB>
	    </AAA>
	   </Body>
	  </Envelope>', 'Southlake Texas');
-- BUG#Z202
select DELETEXML(warehouse_spec, 'Envelope/Body/AAA/BBB/DDD/DDDs/DDD/EEE')
 from warehouse_1 where warehouse_id = 1;
           deletexml            
--------------------------------
 <Envelope>                    +
   <Header/>                   +
   <Body>                      +
     <AAA>                     +
       <BBB>                   +
         <Version>1.0</Version>+
         <DDD>                 +
           <EEE>11</EEE>       +
           <FFF>12</FFF>       +
           <DDDs>              +
             <DDD>             +
               <FFF>112</FFF>  +
             </DDD>            +
           </DDDs>             +
         </DDD>                +
       </BBB>                  +
     </AAA>                    +
   </Body>                     +
 </Envelope>
(1 row)

select DELETEXML(warehouse_spec, 'Envelope/Body/AAA/BBB/DDD/DDDs/DDD')
 from warehouse_1 where warehouse_id = 1;
           deletexml            
--------------------------------
 <Envelope>                    +
   <Header/>                   +
   <Body>                      +
     <AAA>                     +
       <BBB>                   +
         <Version>1.0</Version>+
         <DDD>                 +
           <EEE>11</EEE>       +
           <FFF>12</FFF>       +
           <DDDs/>             +
         </DDD>                +
       </BBB>                  +
     </AAA>                    +
   </Body>                     +
 </Envelope>
(1 row)

-- BUG#Z203
select EXTRACTVALUE(warehouse_spec, 'Envelope/Body/AAA/BBB/DDD/DDDs/DDD')
  from warehouse_1 where warehouse_id = 1;
ERROR:  EXTRACTVALUE returns value of only one node
-- BUG#Z204
select INSERTCHILDXML(warehouse_spec, 'Envelope/Body/AAA/BBB/DDD/DDDs', '"TTT"', xmltype ('<TTT>test</TTT>'))
 from warehouse_1 where warehouse_id = 1;
ERROR:  The document being inserted does not conform to specified child name
-- BUG#Z205
select INSERTXMLBEFORE(warehouse_spec, '//@name/EEE[1]', xmltype ('<TTT>test</TTT>'))
 from warehouse_1 where warehouse_id = 1;
        insertxmlbefore         
--------------------------------
 <Envelope>                    +
   <Header/>                   +
   <Body>                      +
     <AAA>                     +
       <BBB>                   +
         <Version>1.0</Version>+
         <DDD>                 +
           <EEE>11</EEE>       +
           <FFF>12</FFF>       +
           <DDDs>              +
             <DDD>             +
               <EEE>111</EEE>  +
               <FFF>112</FFF>  +
             </DDD>            +
           </DDDs>             +
         </DDD>                +
       </BBB>                  +
     </AAA>                    +
   </Body>                     +
 </Envelope>
(1 row)

drop table warehouse_1;
--
-- Fix BUG#Z214, BUG#Z215
--
create table warehouse_2(
	warehouse_id	number(3) not null,
	warehouse_spec	xmltype,
	warehouse_name	varchar2(35)
);
insert into warehouse_2 values(1,
	'<?xml version="1.0" encoding="UTF-8" standalone="no"?>
	  <Envelope>
	   <Header />
	   <Body>
	    <AAA>
	     <BBB>
	      <Version>1.0</Version>
	      <DDD>
	       <EEE>11</EEE>
	       <FFF>12</FFF>
	       <DDDs>
	        <DDD>
	         <EEE>111</EEE>
	         <FFF>112</FFF>
	        </DDD>
	       </DDDs>
	      </DDD>
	     </BBB>
	    </AAA>
	   </Body>
	  </Envelope>', 'Southlake Texas');
insert into warehouse_2 values(4,
	'<?xml version="1.0" encoding="UTF-8"?>
	  <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">
	   <soapenv:Header />
	   <soapenv:Body>
	    <web:AAA>
	     <web:BBB>
	      <typ:Version>1.0</typ:Version>
	      <typ:DDD>
	       <typ:EEE>41</typ:EEE>
	       <typ:FFF>42</typ:FFF>
	       <typ:DDDs>
	        <typ:DDD>
	         <typ:EEE>411</typ:EEE>
	         <typ:FFF>412</typ:FFF>
	        </typ:DDD>
	       </typ:DDDs>
	      </typ:DDD>
	     </web:BBB>
	    </web:AAA>
	   </soapenv:Body>
	  </soapenv:Envelope>', 'Seattle Washington');
-- BUG#Z214
select EXTRACTVALUE(warehouse_spec, '//@name') from warehouse_2 where warehouse_id = 1;
 extractvalue 
--------------
 
(1 row)

-- BUG#Z215
-- ok
select INSERTCHILDXML(warehouse_spec, 'soapenv:Envelope/soapenv:Body/web:AAA/web:BBB/typ:DDD/typ:DDDs/typ:DDD','RRR', xmltype ('<RRR><TTT>test</TTT><SSS>test</SSS></RRR>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') 
 from warehouse_2 where warehouse_id = 4;
                                                               insertchildxml                                                               
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Header/>                                                                                                                       +
   <soapenv:Body>                                                                                                                          +
     <web:AAA>                                                                                                                             +
       <web:BBB>                                                                                                                           +
         <typ:Version>1.0</typ:Version>                                                                                                    +
         <typ:DDD>                                                                                                                         +
           <typ:EEE>41</typ:EEE>                                                                                                           +
           <typ:FFF>42</typ:FFF>                                                                                                           +
           <typ:DDDs>                                                                                                                      +
             <typ:DDD>                                                                                                                     +
               <typ:EEE>411</typ:EEE>                                                                                                      +
               <typ:FFF>412</typ:FFF>                                                                                                      +
               <RRR>                                                                                                                       +
                 <TTT>test</TTT>                                                                                                           +
                 <SSS>test</SSS>                                                                                                           +
               </RRR>                                                                                                                      +
             </typ:DDD>                                                                                                                    +
           </typ:DDDs>                                                                                                                     +
         </typ:DDD>                                                                                                                        +
       </web:BBB>                                                                                                                          +
     </web:AAA>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

-- ok
select INSERTCHILDXML(warehouse_spec, 'soapenv:Envelope/soapenv:Body/web:AAA/web:BBB/typ:DDD/typ:DDDs/typ:DDD','typ:TTT', xmltype ('<typ:TTT xmlns:typ="http://www.def.com">test</typ:TTT>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') 
 from warehouse_2 where warehouse_id = 4;
                                                               insertchildxml                                                               
--------------------------------------------------------------------------------------------------------------------------------------------
 <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com">+
   <soapenv:Header/>                                                                                                                       +
   <soapenv:Body>                                                                                                                          +
     <web:AAA>                                                                                                                             +
       <web:BBB>                                                                                                                           +
         <typ:Version>1.0</typ:Version>                                                                                                    +
         <typ:DDD>                                                                                                                         +
           <typ:EEE>41</typ:EEE>                                                                                                           +
           <typ:FFF>42</typ:FFF>                                                                                                           +
           <typ:DDDs>                                                                                                                      +
             <typ:DDD>                                                                                                                     +
               <typ:EEE>411</typ:EEE>                                                                                                      +
               <typ:FFF>412</typ:FFF>                                                                                                      +
               <typ:TTT xmlns:typ="http://www.def.com">test</typ:TTT>                                                                      +
             </typ:DDD>                                                                                                                    +
           </typ:DDDs>                                                                                                                     +
         </typ:DDD>                                                                                                                        +
       </web:BBB>                                                                                                                          +
     </web:AAA>                                                                                                                            +
   </soapenv:Body>                                                                                                                         +
 </soapenv:Envelope>
(1 row)

-- error
select INSERTCHILDXML(warehouse_spec, 'soapenv:Envelope/soapenv:Body/web:AAA/web:BBB/typ:DDD/typ:DDDs/typ:DDD','yyy:TTT', xmltype ('<typ:TTT xmlns:typ="http://www.def.com">test</typ:TTT>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') 
 from warehouse_2 where warehouse_id = 4;
ERROR:  The document being inserted does not conform to specified child name
-- error
select INSERTCHILDXML(warehouse_spec, 'soapenv:Envelope/soapenv:Body/web:AAA/web:BBB/typ:DDD/typ:DDDs/typ:DDD','yyy:TTT', xmltype ('<typ:TTT xmlns:typ="http://www.def.com">yyy:TTT</typ:TTT>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') 
 from warehouse_2 where warehouse_id = 4;
ERROR:  The document being inserted does not conform to specified child name
-- error
select INSERTCHILDXML(warehouse_spec, 'soapenv:Envelope/soapenv:Body/web:AAA/web:BBB/typ:DDD/typ:DDDs/typ:DDD','typ:TTT', xmltype ('<typ::TTT xmlns:typ="http://www.def.com">test</typ::TTT>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') 
 from warehouse_2 where warehouse_id = 4;
ERROR:  The document being inserted does not conform to specified child name
-- error
select INSERTCHILDXML(warehouse_spec, 'soapenv:Envelope/soapenv:Body/web:AAA/web:BBB/typ:DDD/typ:DDDs/typ:DDD',':', xmltype ('<typ:TTT xmlns:typ="http://www.def.com">typ:TTT</typ:TTT>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') 
 from warehouse_2 where warehouse_id = 4;
ERROR:  The document being inserted does not conform to specified child name
-- error
select INSERTCHILDXML(warehouse_spec, 'Envelope/Body/AAA/BBB/DDD/DDDs', 'TTT', xmltype ('<yy><TTT>test</TTT></yy>'), 'xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://www.def.com" xmlns:web="http://www.abc.com"') 
 from warehouse_2 where warehouse_id = 1;
ERROR:  The document being inserted does not conform to specified child name
drop table warehouse_2;
